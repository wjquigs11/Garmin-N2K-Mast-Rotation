<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="highcharts.js"></script>
  <style>
    body {
      min-width: 310px;
      max-width: 800px;
      height: auto;
      margin: 0 auto;
    }
    h2 {
      font-family: Arial;
      font-size: 2.5rem;
      text-align: center;
    }
    .container {
      margin-bottom: 20px; /* Space between charts */
    }
  </style>
</head>
<body>
  <h2>ESP Weather</h2>
  <div id="chart-temperature" class="container"></div>
  <div id="chart-humidity" class="container"></div>
  <div id="chart-pressure" class="container"></div>

<script>
  function createChart(container, title, yAxisTitle) {
    return new Highcharts.Chart({
      chart: { renderTo: container },
      title: { text: title },
      series: [{ showInLegend: false, data: [] }],
      plotOptions: {
        line: { animation: false, dataLabels: { enabled: true } }
      },
      xAxis: {
        type: 'datetime',
        dateTimeLabelFormats: { second: '%H:%M:%S' }
      },
      yAxis: { title: { text: yAxisTitle } },
      credits: { enabled: false }
    });
  }

  const chartT = createChart('chart-temperature', 'Cabin Temperature', 'Temperature (Fahrenheit)');
  const chartH = createChart('chart-humidity', 'Humidity', 'Humidity (%)');
  const chartP = createChart('chart-pressure', 'Atmospheric Pressure', 'Pressure (hPa)');

  // Function to fetch data for each chart
  function fetchData(chart, url, currentInterval) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          var x = (new Date()).getTime(),
              y = parseFloat(this.responseText);
          if (chart.series[0].data.length > 40) {
            chart.series[0].addPoint([x, y], true, true, true);
          } else {
            chart.series[0].addPoint([x, y], true, false, true);
          }
          chart.setTitle({ text: `${chart.title.text}: ${y.toFixed(1)}` });
          console.log(chart.title, chart.title.text);
          
          // Increase the interval for the next fetch
          let newInterval = Math.max(currentInterval + 5000, 30000); // Increase by 5000ms, minimum of 30000ms
          console.log("timeout: ", chart, newInterval);
          setTimeout(() => fetchData(chart, url, newInterval), newInterval);
        } else {
          console.error("Error fetching data:", this.statusText);
          // Retry after a fixed interval on error
          setTimeout(() => fetchData(chart, url, currentInterval), currentInterval);
        }
      }
    };
    xhttp.open("GET", url, true);
    xhttp.send();
  }

  // Start fetching data with an initial interval
  let initialInterval = 1000; // Start with a shorter interval
  fetchData(chartT, "http://192.168.68.68/temperature", initialInterval);
  fetchData(chartH, "http://192.168.68.68/humidity", initialInterval);
  fetchData(chartP, "http://192.168.68.68/pressure", initialInterval);
</script>
</body>
</html>
